const NEWLINE = '\r\n';

interface Field {
    name: string;
    type: string;
}

export interface IConstructParams {
    path: string;
    clientName: string;
    receiveType: string;
    sendType: string;
    receiveInterface: string[];
    sendInterface: string[];
}

export function constructTypesFile(params: IConstructParams) {
    let {
        clientName, receiveType, sendType, receiveInterface, sendInterface
    } = params;

    let sendTypes = constructSendTypes(sendInterface, sendType);

    let comments = [
        '// =================================================',
        '// This is an autogenerated file.',
        '// Please refrain from manually modifying this file.',
        '// ================================================='
    ];

    let contents = [
        ...comments,
        '',
        ...receiveInterface,
        ...sendInterface,
        ...sendTypes
    ];
    return {
        fileName: `${clientName}Types.ts`,
        contents: contents.join(NEWLINE)
    };
}
export function constructPrimaryFile(params: IConstructParams) {
    let {
        path, clientName, receiveType, sendType, receiveInterface, sendInterface
    } = params;

    
    let receives = constructReceive(receiveInterface);

    let contents = [
        `import * as io from 'socket.io-client';`,
        `import { ClientTemplate, Client, augmentClient } from '@irysius/anguli-components/Client';`,
        `import { ${receiveType}, ${sendType}, SendTypes } from './${clientName}Types';`,
        `let _${clientName}: ClientTemplate<${receiveType}, ${sendType}> = {`,
        `    path: '${path}',`,
        `    connect: function () { },`,
        `    reconnect: function (attemptNumber: number) { },`,
        `    disconnect: function (reason: string) { },`,
        `    sendTypes: SendTypes,`,
        `    receive: {`,
        ...receives,
        `    },`,
        `};`,
        `export let ${clientName}: Client<${receiveType}, ${sendType}> = augmentClient(_${clientName}, io);`
    ];
    return {
        fileName: `${clientName}.ts`,
        contents: contents.join(NEWLINE)
    };
}

function tab(line: string) {
    return `    ${line}`;
}
function doubleTab(line: string) {
    return `        ${line}`;
}
function matchInterfaceField(line: string): Field {
    let match = /(\w+): (\w+);/g.exec(line);
    if (!match) { return null; }
    return {
        name: match[1],
        type: match[2]
    };
}
function parseFieldsFromInterface(_interface: string[]): Field[] {
    return _interface.map(matchInterfaceField).filter(x => !!x);
}
function constructSendTypes(sendInterface: string[], sendType: string) {
    let fields = parseFieldsFromInterface(sendInterface);
    let lines = fields.map(field => {
        return `${field.name}: null,`
    }).map(tab);
    let contents = [
        `export let SendTypes: ${sendType} = {`,
        ...lines,
        `}`
    ];
    return contents;
    
}
function constructReceive(receiveInterface: string[]) {
    let fields = parseFieldsFromInterface(receiveInterface);
    return fields.map(field => {
        return `${field.name}: function (payload: ${field.type}) { },`
    }).map(doubleTab);
}